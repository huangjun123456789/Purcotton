# Railway 部署配置
# 文档: https://docs.railway.app/reference/config-as-code

[build]
# 使用 Nixpacks 构建（自动检测 Python + Node.js）
builder = "nixpacks"

[build.nixpacksPlan]
# 安装 Python 和 Node.js
providers = ["python", "node"]

[build.nixpacksPlan.phases.setup]
nixPkgs = ["python312", "nodejs_20"]

[build.nixpacksPlan.phases.install]
# 先构建前端，再安装后端依赖
cmds = [
    "cd frontend && npm ci && npm run build",
    "mkdir -p backend/static",
    "cp -r frontend/dist/* backend/static/",
    "cd backend && pip install -r requirements.txt"
]

[deploy]
# 启动命令
startCommand = "cd backend && python main.py"

# 健康检查
healthcheckPath = "/health"
healthcheckTimeout = 300

# 重启策略
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3
